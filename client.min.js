/* Strategy-Game v1.0.0 - 17/12/2016 */
function waitingRoomUpdate(a){var b=[];"string"==typeof a?(b=a.split(" "),b=b.map(function(a){return parseInt(a)})):b=[a],"undefined"!=typeof b[0]&&(data.room.timer=b[0]),"undefined"!=typeof b[1]&&(data.room.forceStartCount=b[1]),"undefined"!=typeof b[2]&&(data.room.playerCount=b[2]),"undefined"!=typeof b[3]&&(data.room.playerLimit=b[3]),"undefined"!=typeof b[4]&&(data.room.minPlayers=b[4]),updateRoom()}function fixMap(a){for(var b,c,d,e=[],f=0;f<a.length;f++)a[f]&&(b={},c=a[f].split(" "),"undefined"!=typeof c[0]&&(b.troops=parseInt(c[0])),"undefined"!=typeof c[1]&&(b.type=parseInt(c[1])),"undefined"!=typeof c[2]&&(d=parseInt(c[2])),"undefined"!=typeof c[3]?b.owner=data.indexes[parseInt(c[3])]:b.owner=null,map.data[d]=b,e.push(d));cleanupViewableTiles()}function fixPlayers(a){for(var b=0;b<a.length;b++)data.players[b].money=a[b].split(" ")[0],data.players[b].land=a[b].split(" ")[1],data.players[b].troops=a[b].split(" ")[2]}function cleanupViewableTiles(){for(var a=[],b=0;b<map.data.length;b++)if(map.data[b].owner===data.id){a[b]=!0;for(var c=0;c<6;c++)map.getTileNeighbour(b,c)&&(a[map.getTileNeighbour(b,c)]=!0)}for(var b=0;b<map.data.length;b++)a[b]||(map.data[b]={owner:null,troops:0,type:TYPES.UNKNOWN});map.selectedTile!==-1&&map.data[map.selectedTile].type===TYPES.UNKNOWN&&(map.selectedTile=-1)}function updateTiles(){for(var a,b=0;b<map.data.length;b++)a=map.data[b],null!==a.owner&&(a.type!==TYPES.CASTLE&&a.type!==TYPES.FORT||(a.troops++,a.owner&&(a.owner.money+=10)),a.type===TYPES.BARRACKS&&data.turn%2===0&&a.troops++,a.type===TYPES.FARM&&a.owner&&(a.owner.money+=10),a.type===TYPES.EMPTY&&data.turn%25===0?(a.troops++,a.owner&&a.owner.money++):data.turn%5===0&&a.owner&&a.owner.money++)}function upgradeTile(a){function b(){socket.emit(EVENT.TILE_UPGRADE,{i:map.selectedTile,u:a})}if(map.selectedTile!==-1){var c=map.selectedTile;if(!map.data[c].owner||map.data[c].owner!==data.id)return!1;map.data[c].type===TYPES.EMPTY&&(a===TYPES.FARM&&data.money>=COST.FARM||a===TYPES.BARRACKS&&data.money>=COST.BARRACKS||a===TYPES.FORT&&data.money>=COST.FORT)&&b(),map.data[c].type===TYPES.FORT&&a===TYPES.CASTLE&&data.money>=COST.CASTLE&&b(),a===TYPES.EMPTY&&map.data[c].type!==TYPES.EMPTY&&map.data[c].type!==TYPES.UNKNOWN&&b()}}function toggleActionBarDetail(){dom.id("action-bar").classList.toggle("expanded"),dom.id("action-toggle-detail").innerText="<"===dom.id("action-toggle-detail").innerText?">":"<"}function getPlayer(a){for(var b=0;b<data.players.length;b++)if(data.players[b].id===a)return data.players[b];return!1}function gameEnd(){map.selectedTile=-1,data.queue=[]}function joinWaitingRoom(){socket.emit(EVENT.JOIN_WAITING_ROOM,dom.id("name").value,function(a){waitingRoomUpdate(a),updateRoom(),dom.changeScreen("start-screen","waiting-room")})}function leaveWaitingRoom(){socket.emit(EVENT.LEAVE_WAITING_ROOM,null),dom.changeScreen("waiting-room","start-screen")}function updateRoom(){dom.id("wr-count").innerText=dom.id("wr-pc").innerText=data.room.playerCount,dom.id("wr-fsc").innerText=data.room.forceStartCount,dom.id("wr-timer").innerText=Math.floor(data.room.timer/60)+":"+(data.room.timer%60<10?"0"+data.room.timer%60:data.room.timer%60),dom.id("wr-player-limit").innerText=data.room.playerLimit,data.room.playerCount<2?(dom.hide("force-start"),dom.hide("wr-timer-cont"),dom.id("wr-cancel").classList.add("fill-gap")):(dom.show("force-start"),dom.show("wr-timer-cont"),dom.id("wr-cancel").classList.remove("fill-gap"))}function toggleForceStart(){dom.id("force-start").classList.toggle("active"),socket.emit(EVENT.FORCE_START_STATUS,dom.id("force-start").classList.contains("active"))}function updatePlayers(){var a=data.players,b=[];a.forEach(function(a){b.push("<tr class='gr-player'><td class='gr-name' style='color: "+a.color+"'>"+a.name+"</td><td class='gr-money'>"+a.money+"</td><td class='gr-land'>"+a.land+"</td><td class='gr-troops'>"+a.troops+"</td></tr>")}),dom.id("gr-players-dump").innerHTML=b.join("")}function exitGame(){map.destroy(),dom.changeScreen("game-room","start-screen"),dom.hide("game-end-modal"),dom.id("messages").innerHTML=""}function updateScroll(){var a=dom.id("messages");a.scrollTop=a.scrollHeight-110}function Map(a,b,c,e,f,g,h){this.socket=a,this.playerID=g,this.data=[],this.client={mouse:{down:!1,x:0,y:0,startX:0,startY:0,offsetX:0,offsetY:0},keys:[]},this.x=0,this.y=0,this.playerData=h,this.generate=function(){this.data=[];for(var a=0;a<this.mapWidth*this.mapHeight;a++)this.data.push({owner:null,troops:0,type:TYPES.UNKNOWN})},this.mapWidth=b,this.mapHeight=c,this.tileSideLength=e,this.tileWidth=2*this.tileSideLength,this.tileHeight=this.tileSideLength*Math.sqrt(3),this.xMultiplier=1.5*this.tileSideLength,this.canvas=f,this.ctx=f.getContext("2d"),this.gridcanvas=document.createElement("canvas"),this.gridctx=this.gridcanvas.getContext("2d"),this.gridcanvas.width=this.xMultiplier*this.mapWidth+this.tileSideLength/2,this.gridcanvas.height=this.tileHeight*this.mapHeight+this.tileHeight/2+4,this.prepareMap=function(){this.ctx.font="14px sans-serif",this.gridctx.font="14px sans-serif",this.gridctx.clearRect(0,0,this.gridcanvas.width,this.gridcanvas.height);for(var a=0;a<this.data.length;a++)d=this.getTileData(a),this.drawHex(d.x,d.y,a,this.gridctx);this.drawSelection(),this.drawQueue()},this.draw=function(){this.ctx.clearRect(0,0,this.canvas.width,this.canvas.height),this.ctx.drawImage(this.gridcanvas,this.x,this.y)},this.prepareAndDrawMap=function(){this.prepareMap(),this.draw()},this.getTileData=function(a){var b=(this.data[a],a%this.mapWidth),c=Math.floor(a/this.mapWidth),d=this.xMultiplier*b,e=this.tileHeight*c;return b%2===1&&(e+=this.tileHeight/2),{x:d,y:e}},this.getAbsoluteTileData=function(a){var b=this.getTileData(a);return b.x+=this.tileWidth/2,b.y+=this.tileHeight/2,b},this.drawHex=function(a,b,c,d){var e=this.data[c];if(d.fillStyle=e.owner?getPlayer(e.owner).color:"lightgrey",e.type===TYPES.UNKNOWN&&(d.fillStyle="#777"),d.beginPath(),d.moveTo(a+this.tileSideLength/2,b),d.lineTo(a+this.xMultiplier,b),d.lineTo(a+2*this.tileSideLength,b+this.tileHeight/2),d.lineTo(a+this.xMultiplier,b+this.tileHeight),d.lineTo(a+this.tileSideLength/2,b+this.tileHeight),d.lineTo(a,b+this.tileHeight/2),d.lineTo(a+this.tileSideLength/2,b),d.fill(),d.stroke(),e.type!==TYPES.EMPTY&&e.type!==TYPES.UNKNOWN){var f=this.getIcon(e.type);d.drawImage(f,a+this.tileWidth/6,b+this.tileHeight/10,this.tileWidth/1.5,this.tileWidth/1.5)}e.troops>0&&(d.fillStyle="white",d.font="14px arial",d.fillText(e.troops,a+this.tileSideLength-d.measureText(e.troops).width/2,b+this.tileHeight/2+4))},this.redrawHex=function(a){var b=this.getTileData(a);this.drawHex(b.x,b.y,a,this.gridctx),this.drawHex(b.x+this.x,b.y+this.y,a,this.ctx)},this.selectedTile=-1,this.selectHex=function(a,b){if("number"!=typeof a)return!1;this.getTileData(a);if(a===this.selectedTile)this.drawHexFlower(0,0,this.selectedTile,this.gridctx,this.drawHex),this.drawHexFlower(this.x,this.y,this.selectedTile,this.ctx,this.drawHex),this.selectedTile=-1,this.updateActionBar();else{if(a<0||a>=this.data.length)return!1;if(b&&(b%this.mapWidth===this.mapWidth-1&&a%this.mapWidth===0||a%this.mapWidth===this.mapWidth-1&&b%this.mapWidth===0))return!1;if(this.data[a].type===TYPES.MOUNTAIN||this.data[a].type===TYPES.UNKNOWN)return!1;this.selectedTile!==-1&&(this.drawHexFlower(0,0,this.selectedTile,this.gridctx,this.drawHex),this.drawHexFlower(this.x,this.y,this.selectedTile,this.ctx,this.drawHex)),this.selectedTile=a,this.updateActionBar(),this.drawSelection()}this.drawQueue()},this.drawSelection=function(){var a=this.getTileData(this.selectedTile);this.drawHexFlower(0,0,this.selectedTile,this.gridctx,this.highlightHex),this.highlightHex(a.x,a.y,this.selectedTile,this.gridctx),this.drawHexFlower(this.x,this.y,this.selectedTile,this.ctx,this.highlightHex),this.highlightHex(a.x+this.x,a.y+this.y,this.selectedTile,this.ctx),this.drawQueue()},this.highlightHex=function(a,b,c,d,e){d.fillStyle=e||"rgba(0, 0, 0, 0.2)",d.beginPath(),d.moveTo(a+this.tileSideLength/2,b),d.lineTo(a+this.xMultiplier,b),d.lineTo(a+2*this.tileSideLength,b+this.tileHeight/2),d.lineTo(a+this.xMultiplier,b+this.tileHeight),d.lineTo(a+this.tileSideLength/2,b+this.tileHeight),d.lineTo(a,b+this.tileHeight/2),d.lineTo(a+this.tileSideLength/2,b),d.fill(),d.stroke()},this.drawHexFlower=function(a,b,c,d,e){function f(c){var f=g.getTileData(c);"number"==typeof c&&e.call(g,f.x+a,f.y+b,c,d)}var g=this;f(c);for(var h=0;h<6;h++)f(g.getTileNeighbour.call(g,c,h))},this.drawQueue=function(){for(var a=0;a<data.queue.length;a++)this.drawQueuePart(data.queue[a],!0);this.draw()},this.drawQueuePart=function(a,b){var c=this.getAbsoluteTileData(a.origin),d=this.getAbsoluteTileData(a.endpoint);this.gridctx.fillStyle=this.gridctx.strokeStyle="black",this.gridctx.beginPath(),this.gridctx.moveTo(c.x,c.y),this.gridctx.lineTo(d.x,d.y),this.gridctx.stroke(),this.gridctx.fillRect(d.x-2,d.y-2,4,4),b||this.draw()},this.getTileNeighbour=function(a,b){if(b%=6,a<0||a>=this.data.length)return!1;var c=0,d=a%2===0;switch(b){case 0:c=a-this.mapWidth;break;case 3:c=a+this.mapWidth;break;case 1:c=d?a-this.mapWidth+1:a+1;break;case 2:c=d?a+1:a+this.mapWidth+1;break;case 4:c=d?a-1:a+this.mapWidth-1;break;case 5:c=d?a-this.mapWidth-1:a-1}return!(c%this.mapWidth===this.mapWidth-1&&a%this.mapWidth===0||a%this.mapWidth===this.mapWidth-1&&c%this.mapWidth===0)&&c>=0&&c<this.data.length&&c},this.hexUnderPoint=function(a){for(var b,c=[],d=0;d<this.data.length;d++)b=this.getTileData(d),b.w=this.tileWidth,b.h=this.tileHeight,this.pointCollision(b,a)&&c.push({hex:b,i:d,dist:Math.hypot(b.x+map.tileWidth/2-a.x-this.x,b.y+map.tileHeight/2-a.y-this.y)});return c.sort(function(a,b){return a.dist-b.dist}),c.length>0&&c[0].i},this.moveSelection=function(a){var b=this.data[this.selectedTile];b.owner===this.playerID&&b.type!==TYPES.MOUNTAIN&&b.type!==TYPES.UNKNOWN&&this.moveTroops(this.selectedTile,this.getTileNeighbour(this.selectedTile,a)),this.selectHex(this.getTileNeighbour(this.selectedTile,a),this.selectedTile)},this.tileExists=function(a){return"number"==typeof a&&a>=0&&a<this.data.length},this.centerTile=function(a){if(!this.tileExists(a))return!1;var b=this.getTileData(a);this.x=Math.floor(-b.x+innerWidth/2),this.y=Math.floor(-b.y+innerHeight/2),this.handleMapBoundaries()},this.pointCollision=function(a,b){return a.x<b.x&&a.x+a.w>b.x&&a.y<b.y&&a.h+a.y>b.y},this.moveTroops=function(a,b){if(!this.tileExists(a)||!this.tileExists(b))return!1;if(this.data[b].type!==TYPES.MOUNTAIN&&this.data[b].type!==TYPES.UNKNOWN&&(this.data[a].owner!==data.id&&this.data[a].troops>1||this.data[a].owner===data.id)){var c={origin:a,endpoint:b};data.moved?(data.queue.push(c),this.drawQueue()):(this.socket.emit(EVENT.MOVE_TROOPS,c),data.moved=!0)}},this.nextInQueue=function(){data.queue.length>0&&(a.emit(EVENT.MOVE_TROOPS,data.queue[0]),data.queue.shift(),data.moved=!0)},this.icons={},this.loadIcon=function(a,b){this.icons[a]=new Image,this.icons[a].src="icons/"+b};for(var i=["barn.png","castle.png","medieval-pavilion.png","peaks.png","stone-tower.png","peaks.png"],j=["farm","castle","barracks","mountains","fort","mountain"],k=0;k<i.length;k++)this.loadIcon(j[k],i[k]);this.typeMap=[null,"castle","fort","farm","barracks","mountain"],this.getIcon=function(a){return this.icons[this.typeMap[a]]},this.handleMapBoundaries=function(){this.x>Math.floor(innerWidth/3)&&(this.x=Math.floor(innerWidth/3)),this.y>Math.floor(innerHeight/3)&&(this.y=Math.floor(innerHeight/3)),this.x<-this.gridcanvas.width+Math.floor(innerWidth/3*2)&&(this.x=-this.gridcanvas.width+Math.floor(innerWidth/3*2)),this.y<-this.gridcanvas.height+Math.floor(innerHeight/3*2)&&(this.y=-this.gridcanvas.height+Math.floor(innerHeight/3*2))},this.updateActionBar=function(){if(dom.id("bd-demolisher").classList.add("disabled"),dom.id("bd-barn").classList.add("disabled"),dom.id("bd-barracks").classList.add("disabled"),dom.id("bd-fort").classList.add("disabled"),dom.id("bd-castle").classList.add("disabled"),this.tileExists(this.selectedTile)&&this.data[this.selectedTile].owner===this.playerID){var a={barn:!1,barracks:!1,fort:!1,castle:!1},b=this.data[this.selectedTile].type;b===TYPES.EMPTY&&(this.playerData.money>=COST.FORT?a.barn=a.barracks=a.fort=!0:this.playerData.money>=COST.BARRACKS?a.barn=a.barracks=!0:this.playerData.money>=COST.FARM&&(a.barn=!0)),b===TYPES.FORT&&this.playerData.money>=COST.CASTLE&&(a.castle=!0),a.barn&&dom.id("bd-barn").classList.remove("disabled"),a.barracks&&dom.id("bd-barracks").classList.remove("disabled"),a.fort&&dom.id("bd-fort").classList.remove("disabled"),a.castle&&dom.id("bd-castle").classList.remove("disabled"),b!==TYPES.EMPTY&&b!==TYPES.UNKNOWN&&b!==TYPES.CASTLE&&dom.id("bd-demolisher").classList.remove("disabled")}},this.mousedown=function(){this.client.mouse.startX=this.client.mouse.x,this.client.mouse.startY=this.client.mouse.y,this.client.mouse.offsetX=this.client.mouse.x-this.x,this.client.mouse.offsetY=this.client.mouse.y-this.y},this.mouseup=function(){if(this.client.mouse.startX===this.client.mouse.x&&this.client.mouse.startY===this.client.mouse.y){var a=this.hexUnderPoint({x:this.client.mouse.x-this.x,y:this.client.mouse.y-this.y});a!==!1&&this.selectHex(a)}this.client.mouse.startX=0,this.client.mouse.startY=0},this.mousemove=function(){this.client.mouse.down&&(this.x=this.client.mouse.x-this.client.mouse.offsetX,this.y=this.client.mouse.y-this.client.mouse.offsetY,this.handleMapBoundaries(),this.draw())},this.keydown=function(a){if(this.selectedTile!==-1)switch(a){case 81:this.moveSelection(5);break;case 87:this.moveSelection(0);break;case 69:this.moveSelection(1);break;case 65:this.moveSelection(4);break;case 83:this.moveSelection(3);break;case 68:this.moveSelection(2)}},this.keyup=function(a){},this.setupCanvas=function(){this.canvas.width=innerWidth,this.canvas.height=innerHeight,this.prepareAndDrawMap()},this.evt={},this.evt.mousedown=function(a){this.client.mouse.down=!0,this.client.mouse.x=a.clientX,this.client.mouse.y=a.clientY,this.mousedown()}.bind(this),this.canvas.addEventListener("mousedown",this.evt.mousedown),this.evt.mousemove=function(a){this.client.mouse.x=a.clientX,this.client.mouse.y=a.clientY,this.mousemove()}.bind(this),this.canvas.addEventListener("mousemove",this.evt.mousemove),this.evt.mouseup=function(a){this.client.mouse.down=!1,this.client.mouse.x=a.clientX,this.client.mouse.y=a.clientY,this.mouseup()}.bind(this),this.canvas.addEventListener("mouseup",this.evt.mouseup),this.evt.mouseout=function(){this.client.mouse.down=!1,this.mouseup()}.bind(this),document.addEventListener("mouseout",this.evt.mouseout),this.evt.keydown=function(a){this.client.keys[a.which||a.keyCode]=!0,document.activeElement!==dom.id("chatbox")&&this.keydown(a.which||a.keyCode)}.bind(this),document.addEventListener("keydown",this.evt.keydown),this.evt.keyup=function(a){this.client.keys[a.which||a.keyCode]=!1,document.activeElement!==dom.id("chatbox")&&this.keyup(a.which||a.keyCode)}.bind(this),document.addEventListener("keyup",this.evt.keyup),this.evt.windowResize=this.setupCanvas.bind(this),window.addEventListener("resize",this.evt.windowResize),this.destroy=function(){this.canvas.removeEventListener("mousedown",this.evt.mousedown),this.canvas.removeEventListener("mousemove",this.evt.mousemove),this.canvas.removeEventListener("mouseup",this.evt.mouseup),document.removeEventListener("mouseout",this.evt.mouseout),document.removeEventListener("keydown",this.evt.keydown),document.removeEventListener("keyup",this.evt.keyup),window.removeEventListener("resize",this.evt.windowResize)},this.generate(),this.setupCanvas()}var socket=io(),data={room:{},players:[],indexes:[],moved:!1,queue:[]},TYPES={UNKNOWN:-1,EMPTY:0,CASTLE:1,FORT:2,FARM:3,BARRACKS:4,MOUNTAIN:5},EVENT={SERVER_CONNECT:0,JOIN_WAITING_ROOM:1,WAITING_ROOM_UPDATE:2,FORCE_START_STATUS:3,GAME_START:4,LEAVE_WAITING_ROOM:5,MAP_INITIALISATION:6,MAP_UPDATE:7,MOVE_TROOPS:8,PLAYER_CAPTURED:9,PLAYER_UPDATE:10,GAME_WON:11,TILE_UPGRADE:12,CHAT_MESSAGE:13},COST={CASTLE:5e3,FORT:2e3,BARRACKS:500,FARM:200};socket.on(EVENT.SERVER_CONNECT,function(a){data.id=a}),socket.on(EVENT.WAITING_ROOM_UPDATE,function(a){waitingRoomUpdate(a)}),socket.on(EVENT.GAME_START,function(a){data.players=a,updatePlayers()}),socket.on(EVENT.MAP_INITIALISATION,function(a){map=new Map(socket,a.w,a.h,30,canvas,data.id,data),data.turn=a.turn,data.indexes=a.indexes,fixMap(a.map);for(var b=0;b<map.data.length;b++)map.data[b].owner&&map.centerTile(b);map.prepareAndDrawMap(),dom.changeScreen("waiting-room","game-room"),dom.id("force-start").classList.remove("active"),map.updateActionBar()}),socket.on(EVENT.MAP_UPDATE,function(a){data.turn=a.turn,dom.id("turn-count").innerText=a.turn,data.money=a.money,dom.id("money-count").innerText=a.money,fixPlayers(a.players),updatePlayers(),updateTiles(),fixMap(a.map),map.prepareAndDrawMap(),map.updateActionBar(),data.moved=!1,map.nextInQueue()}),socket.on(EVENT.PLAYER_UPDATE,function(a){data.players=a,updatePlayers()}),socket.on(EVENT.PLAYER_CAPTURED,function(a){dom.show("gr-lose"),dom.hide("gr-win"),dom.show("game-end-modal"),gameEnd()}),socket.on(EVENT.GAME_WON,function(a){dom.show("gr-win"),dom.hide("gr-lose"),dom.show("game-end-modal"),gameEnd()});var canvas=document.getElementById("map"),map,dom={};dom.id=function(a){return document.getElementById(a)},dom.className=function(a){return document.getElementsByClassName(a)},dom.hide=function(a){this.id(a).classList.add("hidden")},dom.show=function(a){this.id(a).classList.remove("hidden")},dom.changeScreen=function(a,b){this.hide(a),this.show(b)},dom.id("chatbox").addEventListener("keydown",function(a){13===a.which&&(socket.emit(EVENT.CHAT_MESSAGE,dom.id("chatbox").value),dom.id("chatbox").value="")}),socket.on(EVENT.CHAT_MESSAGE,function(a){var b="";b="p"===a.t?"<div class='message'><span style='color: "+getPlayer(data.indexes[a.i]).color+"'>"+getPlayer(data.indexes[a.i]).name+": </span>"+a.m+"</div>":"<div class='message'><b>"+a.m+"</b></div>",dom.id("messages").innerHTML+=b,updateScroll()});